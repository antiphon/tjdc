<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="tjdc">
<title>Example analysis â€¢ tjdc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example analysis">
<meta property="og:description" content="tjdc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tjdc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/example_analysis.html">Example analysis</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Example analysis</h1>
            
      
      
      <div class="d-none name"><code>example_analysis.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://antiphon.github.io/tjdc/">tjdc</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>Use the internal example, which is a datacube with clear blocks of
changepoints.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"easystripes"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">easystripes</span><span class="op">$</span><span class="va">strip</span></span>
<span><span class="co"># the truth</span></span>
<span><span class="va">j</span> <span class="op">&lt;-</span> <span class="va">easystripes</span><span class="op">$</span><span class="va">jump</span></span>
<span><span class="co"># as data frame</span></span>
<span><span class="va">xdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tj_stars_to_data.html">tj_stars_to_data</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> </span>
<span><span class="va">jdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>c_x <span class="op">=</span> <span class="va">x</span>, c_y <span class="op">=</span> <span class="va">y</span>, jump_after <span class="op">=</span> <span class="va">values</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add truth</span></span>
<span><span class="va">df</span>  <span class="op">&lt;-</span> <span class="va">xdf</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span>  <span class="va">jdf</span>   <span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(c_x, c_y)`</span></span>
<span></span>
<span><span class="co"># Some examples</span></span>
<span><span class="va">df_ex</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">jump_after</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span> <span class="va">cell</span> <span class="op"><a href="https://mc-stan.org/posterior/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">cell</span><span class="op">)</span>, <span class="fl">30</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>This datacube has <span class="math inline">\(T=11\)</span>
timepoints, and a clear structure of where the changes take place.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">x</span> <span class="op">)</span></span></code></pre></div>
<p><img src="example_analysis_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>Here are examples of the series with different changepoints. Note
that jumping after <span class="math inline">\(t=11\)</span> is the same
as not having a changepoint.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_ex</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span>, group <span class="op">=</span> <span class="va">cell</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">jump_after</span><span class="op">)</span></span></code></pre></div>
<p><img src="example_analysis_files/figure-html/unnamed-chunk-4-1.png" width="576"></p>
<div class="section level3">
<h3 id="fit-the-model">Fit the model<a class="anchor" aria-label="anchor" href="#fit-the-model"></a>
</h3>
<p>The most up-to-date fitting function is at the moment called
<code>tj_fit_m0.6</code></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set prior: negative jumps only.</span></span>
<span><span class="va">p_d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">0</span>, s2 <span class="op">=</span> <span class="fl">1e4</span>, a <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, b <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tj_fit_m0.6.html">tj_fit_m0.6</a></span><span class="op">(</span><span class="va">x</span>, </span>
<span>                     prior_k <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>                     niter <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                     prior_delta <span class="op">=</span> <span class="va">p_d</span>,</span>
<span>                     verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>By default,</p>
<ul>
<li>The pixel-to-pixel â€˜correlationâ€™ term <span class="math inline">\(\gamma=0\)</span> so <em>no</em> spatial
interaction is set (see <code>gamma</code>)</li>
<li>The priors are pretty flat
<ul>
<li>see <code>prior_theta</code> for the linear model parameters (2D
Gaussian i.i.d. over pixels)</li>
<li>see <code>prior_delta</code> for the jump-size parameter, (1D
truncated Gaussian i.i.d. over pixels)</li>
<li>see <code>prior_sigma2</code> for residual variance (Gamma, one for
all pixels)</li>
<li>see <code>prior_k</code> the prior probability of jumps; <span class="math inline">\(T\)</span>-vector or 1 value for <span class="math inline">\(1-P(no~jump)\)</span>
</li>
</ul>
</li>
<li>
<em>all</em> of the MCMC traces are kept in the output (see
<code>keep_hist</code> parameter in the help).</li>
</ul>
<p>The proposed model is activated by setting <span class="math inline">\(\gamma\neq 0\)</span>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tj_fit_m0.6.html">tj_fit_m0.6</a></span><span class="op">(</span><span class="va">x</span>, </span>
<span>                     gamma <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>                     prior_k <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>                     niter <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                     prior_delta <span class="op">=</span> <span class="va">p_d</span>,</span>
<span>                     verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>There are many components in the result object, but most importantly
the posteriors are in</p>
<ul>
<li>
<code>k</code>: The posterior probabilities for a jump, in format
<code>k[t,i]</code>. So for example, the probability of no jump of pixel
1 when <span class="math inline">\(T=11\)</span> is in
<code>k[1,11]</code>. The probability of a jump somewhere is also
returned in component <code>z</code>
</li>
<li>
<code>theta_m</code>, <code>theta_Suppetri</code>: The posterior
mean and (upper triangle of) covariance for the vector <span class="math inline">\((\theta,\delta)\)</span> (regression + jump)</li>
<li>
<code>sigma2</code>: Residual variance</li>
</ul>
<p><strong>Example</strong>: Check convergence.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># example cell:</span></span>
<span><span class="va">c</span> <span class="op">&lt;-</span> <span class="fl">123</span></span>
<span><span class="va">tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">$</span><span class="va">hist_theta</span><span class="op">[</span>,<span class="va">c</span>,<span class="op">]</span>,</span>
<span>            <span class="va">fit1</span><span class="op">$</span><span class="va">hist_z</span><span class="op">[</span>,<span class="va">c</span><span class="op">]</span>,</span>
<span>            <span class="va">fit1</span><span class="op">$</span><span class="va">hist_sigma2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"d"</span>, <span class="st">"P(jump)"</span>, <span class="st">"sigma2"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># use `posterior` etc.</span></span>
<span><span class="va">trp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws.html" class="external-link">as_draws</a></span><span class="op">(</span><span class="va">tr</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span> <span class="va">trp</span> <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 Ã— 10</span></span></span>
<span><span class="co">#&gt;   variable    mean  median      sd   mad      q5    q95  rhat ess_bulk ess_tail</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;num&gt;</span> <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;num&gt;</span> <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;num&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> a         99.1    98.6   11.3    11.3   79.8   119.    1.14     5.65     53.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> b          0.378   0.380  1.19    1.18  -<span style="color: #BB0000;">1.58</span>    2.26  1.06    18.9     132. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> d        -<span style="color: #BB0000;">31.0</span>   -<span style="color: #BB0000;">30.8</span>   13.8    13.3  -<span style="color: #BB0000;">54.1</span>    -<span style="color: #BB0000;">7.55</span>  1.22     3.92     33.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> P(jump)    0.998   1      0.022<span style="text-decoration: underline;">3</span>  0      0.997   1     1.13     7.19     <span style="color: #BB0000;">NA</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> sigma2   104.    104.     1.91    1.89 101.    107.    1.01   306.      409.</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tr</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>iter <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">iter</span><span class="op">)</span>  <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">iter</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span>, scale <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example_analysis_files/figure-html/unnamed-chunk-8-1.png" width="576"></p>
<p><strong>Example</strong>: get the most likely jump times.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pk0_most_likely</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fit0</span><span class="op">$</span><span class="va">k</span>, <span class="fl">2</span>, <span class="va">which.max</span><span class="op">)</span></span>
<span><span class="va">pk1_most_likely</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">$</span><span class="va">k</span>, <span class="fl">2</span>, <span class="va">which.max</span><span class="op">)</span></span>
<span><span class="va">pk0df</span>           <span class="op">&lt;-</span> <span class="va">fit0</span><span class="op">$</span><span class="va">cell_info</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>jump_after <span class="op">=</span> <span class="va">pk0_most_likely</span><span class="op">)</span></span>
<span><span class="va">pk1df</span>           <span class="op">&lt;-</span> <span class="va">fit1</span><span class="op">$</span><span class="va">cell_info</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>jump_after <span class="op">=</span> <span class="va">pk1_most_likely</span><span class="op">)</span></span></code></pre></div>
<p>Compare to truth:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Gather estimates</span></span>
<span><span class="va">df_o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">pk0df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"independent"</span><span class="op">)</span>,</span>
<span>                  <span class="va">pk1df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"interactions"</span><span class="op">)</span>,</span>
<span>                  <span class="va">df</span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"truth"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">jump_after</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># pretty color</span></span>
<span><span class="va">cc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">10</span>, palette <span class="op">=</span> <span class="st">"PuOr"</span><span class="op">)</span>, <span class="st">"black"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">df_o</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">c_x</span>, <span class="va">c_y</span>, fill <span class="op">=</span> <span class="va">est</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cc</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">model</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="example_analysis_files/figure-html/unnamed-chunk-10-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="naive-parallelisation">Naive parallelisation<a class="anchor" aria-label="anchor" href="#naive-parallelisation"></a>
</h3>
<p>Large dimension cube can be split into smaller cubes at the spatial
domain (raster), and model fitted to each subset separately and
independently, facilitating simple parallelisation. Due to the spatial
dependency structure, it is a good idea to overlap the regions a bit.
There are three useful functions here:</p>
<ol style="list-style-type: decimal">
<li>
<code>tj_divide_raster</code>: Create the geometry of the
subsets</li>
<li>
<code>tj_fit_m0.x</code>: Fit a model to each subset, and handle
collection and possible storage writing</li>
<li>
<code>tj_stitcher_m0.x</code>: Collect the results.</li>
</ol>
<p>First we want to create the mosaic.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tiling</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tj_divide_raster.html">tj_divide_raster</a></span><span class="op">(</span><span class="va">x</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>, buffer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The result contains info on the tiling. For example, <code>sf</code>
polygons of the tiles are available.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tiling</span><span class="op">$</span><span class="va">poly</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span> data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> , fill <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html" class="external-link">expand_limits</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">8</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p><img src="example_analysis_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
<p>Here we have split the raster bounding box into <span class="math inline">\(3\)</span>-columns-<span class="math inline">\(1\)</span>-rows separate boxes, with overlap of 2
pixels.</p>
<p>Then we use the wrapper to fit the model on each subset.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitm_l</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tj_fit_m0.x.html">tj_fit_m0.x</a></span><span class="op">(</span><span class="va">x</span>, </span>
<span>                    timevar <span class="op">=</span> <span class="st">"z"</span>,</span>
<span>                    tiling <span class="op">=</span> <span class="va">tiling</span>,</span>
<span>                    niter <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                    prior_k <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>                    gamma <span class="op">=</span> <span class="fl">.6</span>, </span>
<span>                    prior_delta <span class="op">=</span> <span class="va">p_d</span>,</span>
<span>                    model_variant <span class="op">=</span> <span class="st">"m0.6"</span>,</span>
<span>                    ncores <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [m0.x 3c][1/1][ave time 5.385954 secs, -4.8e-05 secs left, ready 2023-06-01 15:49:51]     </span></span>
<span><span class="co">#&gt; [m0.x 3c][1/1][ave time 5.385954 secs][total time: 5.387261 secs]</span></span></code></pre></div>
<p>By default all stuff is kept in memory. See the documentation on how
to store each fit into custom file location.</p>
<p>The result is a list of fits, and needs to be parsed together,
particularly the pixels in the overlapping sections need to be made
unique.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># parse the results from separate tiles</span></span>
<span><span class="va">fitm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tj_stitcher_m0.x.html">tj_stitcher_m0.x</a></span><span class="op">(</span><span class="va">fitm_l</span>, <span class="va">tiling</span><span class="op">)</span></span></code></pre></div>
<p>Which has a similar structure as the earlier examples.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pkm_most_likely</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fitm</span><span class="op">$</span><span class="va">k</span>, <span class="fl">2</span>, <span class="va">which.max</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pkmdf</span> <span class="op">&lt;-</span> <span class="va">fitm</span><span class="op">$</span><span class="va">cell_info</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># this table contains duplicate rows for cells in the overlaps</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cell</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span> cell <span class="op">=</span> <span class="va">fitm</span><span class="op">$</span><span class="va">cells</span>, jump_after <span class="op">=</span> <span class="va">pkm_most_likely</span> <span class="op">)</span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(cell)`</span></span>
<span>  </span>
<span></span>
<span><span class="co"># Gather estimates</span></span>
<span><span class="va">df_o2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">pk1df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"full"</span><span class="op">)</span>,</span>
<span>                   <span class="va">pkmdf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"in parts"</span><span class="op">)</span> <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">jump_after</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">df_o2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">c_x</span>, <span class="va">c_y</span>, fill <span class="op">=</span> <span class="va">est</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cc</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">model</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span></code></pre></div>
<p><img src="example_analysis_files/figure-html/unnamed-chunk-15-1.png" width="576"></p>
<p>Note that for parallel fits the variance parameters will be estimated
separately.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s2</span> <span class="op">&lt;-</span> <span class="va">fitm</span><span class="op">$</span><span class="va">hist_sigma2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws.html" class="external-link">as_draws</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">s2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sigma2_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">s2</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 Ã— 10</span></span></span>
<span><span class="co">#&gt;   variable  mean median    sd   mad    q5   q95  rhat ess_bulk ess_tail</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;num&gt;</span> <span style="color: #949494; font-style: italic;">&lt;num&gt;</span> <span style="color: #949494; font-style: italic;">&lt;num&gt;</span> <span style="color: #949494; font-style: italic;">&lt;num&gt;</span> <span style="color: #949494; font-style: italic;">&lt;num&gt;</span> <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;num&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;num&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> sigma2_1  108.   105.  25.5  3.92  99.2  115.  1.06     12.2     10.8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> sigma2_2  110.   107.  29.9  3.85 101.   115.  1.01     75.7     19.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> sigma2_3  104.   101.  26.8  3.88  94.9  107.  1.01    140.      36.9</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tuomas Rajala.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
